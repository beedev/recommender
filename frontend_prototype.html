<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESAB Agentic AI Welding Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --esab-gold: #EAB308;
            --esab-dark: #1F2937;
            --esab-copper: #B45309;
        }
        
        body {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 30%, #654321 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .status-online { @apply bg-green-500 shadow-green-500/50; }
        .status-offline { @apply bg-red-500 shadow-red-500/50; }
        .status-warning { @apply bg-yellow-500 shadow-yellow-500/50; }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .nav-tab {
            background-color: transparent;
            color: #000;
            border: 2px solid transparent;
        }
        
        .nav-tab:hover {
            background-color: #000;
            color: #EAB308;
        }
        
        .nav-tab.active {
            background-color: #000;
            color: #EAB308;
            border: 2px solid #EAB308;
        }
        
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        .message-user {
            background: var(--esab-gold);
            color: black;
            margin-left: auto;
            max-width: 80%;
        }
        
        .message-sparky {
            background: white;
            color: black;
            margin-right: auto;
            max-width: 80%;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .esab-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--esab-gold);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .esab-button {
            background: var(--esab-gold);
            color: black;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .esab-button:hover {
            background: var(--esab-copper);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-yellow-400 p-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-6">
                <div class="bg-black px-6 py-2 transform -skew-x-12">
                    <span class="font-black text-yellow-400 text-xl transform skew-x-12 inline-block">ESAB</span>
                </div>
                <h1 class="text-black font-bold text-xl">Agentic AI Welding Recommender</h1>
                <div id="systemStatus" class="flex items-center gap-2">
                    <span class="status-indicator status-offline"></span>
                    <span id="statusText" class="text-sm font-medium">Connecting...</span>
                </div>
            </div>
            
            <!-- Navigation Links -->
            <div class="flex items-center gap-2">
                <button id="chatTab" class="nav-tab active px-4 py-2 rounded-lg font-medium transition-colors">
                    <i data-lucide="message-square" class="w-4 h-4 inline mr-2"></i>
                    <span data-i18n="chat">Chat</span>
                </button>
                <a href="guided_flow.html" class="nav-tab px-4 py-2 rounded-lg font-medium transition-colors text-decoration-none esab-button">
                    <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>
                    <span data-i18n="guided_flow">Guided Builder</span>
                </a>
                <a href="health_dashboard.html" class="nav-tab px-4 py-2 rounded-lg font-medium transition-colors text-decoration-none">
                    <i data-lucide="activity" class="w-4 h-4 inline mr-2"></i>
                    <span data-i18n="health_dashboard">Health Dashboard</span>
                </a>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Language Selector -->
                <div class="relative">
                    <select id="languageSelector" class="bg-black text-yellow-400 px-3 py-2 rounded-lg border-2 border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    </select>
                </div>
                
                <div class="text-right">
                    <div class="text-black text-sm" data-i18n="welcome">Welcome</div>
                    <div class="text-black font-bold" data-i18n="welding_expert">Welding Expert</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-6 min-h-screen">
        
        <!-- Chat Page -->
        <div id="chatPage" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Sparky Chat -->
                <div class="lg:col-span-2">
                    <div class="esab-card p-6 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-yellow-400 rounded-full w-12 h-12 flex items-center justify-center">
                        <i data-lucide="zap" class="w-6 h-6 text-black"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" data-i18n="ask_sparky">Ask Sparky</h2>
                        <p class="text-gray-600" data-i18n="sparky_description">AI-powered welding equipment recommendations</p>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto space-y-4 mb-6">
                    <div class="message-sparky p-4 rounded-lg fade-in">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="zap" class="w-4 h-4 text-yellow-600"></i>
                            <span class="font-medium text-gray-900">Sparky</span>
                        </div>
                        <div class="text-gray-800" data-i18n="sparky_welcome">
                            Hello! I'm Sparky, your AI welding assistant. I can help you with:
                            <br>â€¢ Finding the perfect welding equipment
                            <br>â€¢ Building Trinity packages (PowerSource + Feeder + Cooler)
                            <br>â€¢ Product compatibility validation
                            <br>â€¢ Expert and guided recommendations
                            <br><br>What welding challenge can I help you solve today?
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="border-t pt-4">
                    <div class="flex gap-3">
                        <input 
                            id="chatInput" 
                            type="text" 
                            data-i18n-placeholder="input_placeholder"
                            placeholder="Ask about welding packages, compatibility, or get recommendations..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                        >
                        <button id="sendMessage" class="esab-button px-6 py-3 rounded-lg">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2">
                        <button class="suggestion-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm">
                            I want to form a package with Aristo 500 ix
                        </button>
                        <button class="suggestion-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm">
                            Multi-process welding machine
                        </button>
                        <button class="suggestion-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm">
                            MIG welding for aluminum
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Package Pricing -->
        <div class="space-y-6">
            
            <!-- Package Pricing Display -->
            <div id="packageDisplay" class="esab-card p-8 min-h-[600px]">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <i data-lucide="package" class="w-8 h-8 text-blue-600"></i>
                    <span data-i18n="recommended_package">Recommended Package</span>
                </h3>
                <div id="packageContent">
                    <div class="text-center py-16 text-gray-500">
                        <i data-lucide="package-search" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <h4 class="text-xl font-semibold mb-3" data-i18n="pricing_details">Pricing Details</h4>
                        <p class="mb-6" data-i18n="no_package_selected">Ask Sparky for a recommendation to see pricing details</p>
                        <button id="demoPackageBtn" class="px-6 py-3 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 transition-colors font-semibold">
                            <span data-i18n="show_demo_package">Show Demo Package</span>
                        </button>
                    </div>
                </div>
            </div>
            
            </div>
        </div>
        
        
    </div>

    <script>
        // Multilingual Translation System
        const translations = {
            en: {
                welcome: "Welcome",
                welding_expert: "Welding Expert",
                ask_sparky: "Ask Sparky",
                sparky_description: "AI-powered welding equipment recommendations",
                sparky_welcome: "Hello! I'm Sparky, your AI welding assistant. I can help you with:<br>â€¢ Finding the perfect welding equipment<br>â€¢ Building Trinity packages (PowerSource + Feeder + Cooler)<br>â€¢ Product compatibility validation<br>â€¢ Expert and guided recommendations<br><br>What welding challenge can I help you solve today?",
                input_placeholder: "Ask about welding packages, compatibility, or get recommendations...",
                trinity_package: "Trinity Package",
                total_price: "Total Price",
                package_contents: "Package Contents",
                compatibility_confidence: "Compatibility Confidence",
                each: "Each",
                ready_to_ship: "Ready to ship",
                package_includes: "Package includes installation guide and warranty",
                recommended_package: "Recommended Package",
                no_package_selected: "Ask Sparky for a recommendation to see pricing details",
                show_demo_package: "Show Demo Package",
                pricing_details: "Pricing Details",
                chat: "Chat",
                health_dashboard: "Health Dashboard"
            },
            es: {
                welcome: "Bienvenido",
                welding_expert: "Experto en Soldadura",
                health_check: "Control de Salud",
                ask_sparky: "Pregunta a Sparky",
                sparky_description: "Recomendaciones de equipos de soldadura con IA",
                sparky_welcome: "Â¡Hola! Soy Sparky, tu asistente de soldadura con IA. Puedo ayudarte con:<br>â€¢ Encontrar el equipo de soldadura perfecto<br>â€¢ Construir paquetes Trinity (Fuente de Poder + Alimentador + Enfriador)<br>â€¢ ValidaciÃ³n de compatibilidad de productos<br>â€¢ Recomendaciones expertas y guiadas<br><br>Â¿QuÃ© desafÃ­o de soldadura puedo ayudarte a resolver hoy?",
                input_placeholder: "Pregunta sobre paquetes de soldadura, compatibilidad o recomendaciones...",
                system_health: "Salud del Sistema",
                backend_api: "API Backend",
                database: "Base de Datos",
                ai_models: "Modelos IA",
                online: "En lÃ­nea",
                offline: "Desconectado",
                langsmith_observability: "Observabilidad LangSmith",
                trace_id: "ID de Traza",
                language: "Idioma",
                mode: "Modo",
                confidence: "Confianza",
                trinity_package: "Paquete Trinity",
                total_price: "Precio Total",
                package_contents: "Contenido del Paquete",
                compatibility_confidence: "Confianza de Compatibilidad",
                each: "Cada uno",
                ready_to_ship: "Listo para enviar",
                package_includes: "El paquete incluye guÃ­a de instalaciÃ³n y garantÃ­a",
                recommended_package: "Paquete Recomendado",
                no_package_selected: "Pregunta a Sparky por una recomendaciÃ³n para ver detalles de precios",
                show_demo_package: "Mostrar Paquete Demo",
                pricing_details: "Detalles de Precios",
                chat: "Chat",
                health_dashboard: "Panel de Salud",
                performance: "Rendimiento",
                response_time: "Tiempo de Respuesta",
                requests: "Solicitudes",
                success_rate: "Tasa de Ã‰xito",
                no_active_traces: "Sin trazas activas",
                api_endpoints: "Endpoints API",
                system_info: "InformaciÃ³n del Sistema",
                frontend_version: "VersiÃ³n Frontend",
                session_id: "ID de SesiÃ³n",
                uptime: "Tiempo Activo",
                quick_actions: "Acciones RÃ¡pidas",
                refresh_health: "Actualizar Salud",
                clear_metrics: "Limpiar MÃ©tricas"
            },
            fr: {
                welcome: "Bienvenue",
                welding_expert: "Expert en Soudure",
                health_check: "ContrÃ´le de SantÃ©",
                ask_sparky: "Demandez Ã  Sparky",
                sparky_description: "Recommandations d'Ã©quipements de soudage alimentÃ©es par l'IA",
                sparky_welcome: "Bonjour ! Je suis Sparky, votre assistant de soudage IA. Je peux vous aider avec :<br>â€¢ Trouver l'Ã©quipement de soudage parfait<br>â€¢ Construire des packages Trinity (Source d'alimentation + Alimentateur + Refroidisseur)<br>â€¢ Validation de compatibilitÃ© des produits<br>â€¢ Recommandations expertes et guidÃ©es<br><br>Quel dÃ©fi de soudage puis-je vous aider Ã  rÃ©soudre aujourd'hui ?",
                input_placeholder: "Demandez sur les packages de soudage, la compatibilitÃ© ou les recommandations...",
                system_health: "SantÃ© du SystÃ¨me",
                backend_api: "API Backend",
                database: "Base de DonnÃ©es",
                ai_models: "ModÃ¨les IA",
                online: "En ligne",
                offline: "Hors ligne",
                langsmith_observability: "ObservabilitÃ© LangSmith",
                trace_id: "ID de Trace",
                language: "Langue",
                mode: "Mode",
                confidence: "Confiance",
                trinity_package: "Package Trinity",
                total_price: "Prix Total",
                package_contents: "Contenu du Package",
                compatibility_confidence: "Confiance de CompatibilitÃ©",
                each: "Chaque",
                ready_to_ship: "PrÃªt Ã  expÃ©dier",
                package_includes: "Le package inclut un guide d'installation et une garantie",
                recommended_package: "Package RecommandÃ©",
                no_package_selected: "Demandez Ã  Sparky une recommandation pour voir les dÃ©tails de prix",
                show_demo_package: "Afficher Package DÃ©mo",
                pricing_details: "DÃ©tails des Prix"
            },
            de: {
                welcome: "Willkommen",
                welding_expert: "SchweiÃŸexperte",
                health_check: "GesundheitsprÃ¼fung",
                ask_sparky: "Fragen Sie Sparky",
                sparky_description: "KI-gestÃ¼tzte SchweiÃŸgerÃ¤te-Empfehlungen",
                sparky_welcome: "Hallo! Ich bin Sparky, Ihr KI-SchweiÃŸassistent. Ich kann Ihnen helfen bei:<br>â€¢ Perfekte SchweiÃŸausrÃ¼stung finden<br>â€¢ Trinity-Pakete erstellen (Stromquelle + Drahtvorschub + KÃ¼hler)<br>â€¢ ProduktkompatibilitÃ¤t validieren<br>â€¢ Experten- und gefÃ¼hrte Empfehlungen<br><br>Welche SchweiÃŸherausforderung kann ich Ihnen heute lÃ¶sen helfen?",
                input_placeholder: "Fragen Sie nach SchweiÃŸpaketen, KompatibilitÃ¤t oder Empfehlungen...",
                system_health: "Systemgesundheit",
                backend_api: "Backend-API",
                database: "Datenbank",
                ai_models: "KI-Modelle",
                online: "Online",
                offline: "Offline",
                langsmith_observability: "LangSmith Observierbarkeit",
                trace_id: "Trace-ID",
                language: "Sprache",
                mode: "Modus",
                confidence: "Vertrauen",
                trinity_package: "Trinity-Paket",
                total_price: "Gesamtpreis",
                package_contents: "Paketinhalt",
                compatibility_confidence: "KompatibilitÃ¤t Vertrauen",
                each: "Jeweils",
                ready_to_ship: "Versandbereit",
                package_includes: "Paket enthÃ¤lt Installationsanleitung und Garantie",
                recommended_package: "Empfohlenes Paket",
                no_package_selected: "Fragen Sie Sparky nach einer Empfehlung, um Preisdetails zu sehen",
                show_demo_package: "Demo-Paket Anzeigen",
                pricing_details: "Preisdetails"
            },
            pt: {
                welcome: "Bem-vindo",
                welding_expert: "Especialista em Soldagem",
                health_check: "VerificaÃ§Ã£o de SaÃºde",
                ask_sparky: "Pergunte ao Sparky",
                sparky_description: "RecomendaÃ§Ãµes de equipamentos de soldagem com IA",
                sparky_welcome: "OlÃ¡! Eu sou o Sparky, seu assistente de soldagem com IA. Posso ajudÃ¡-lo com:<br>â€¢ Encontrar o equipamento de soldagem perfeito<br>â€¢ Construir pacotes Trinity (Fonte de Energia + Alimentador + Resfriador)<br>â€¢ ValidaÃ§Ã£o de compatibilidade de produtos<br>â€¢ RecomendaÃ§Ãµes especializadas e guiadas<br><br>Que desafio de soldagem posso ajudÃ¡-lo a resolver hoje?",
                input_placeholder: "Pergunte sobre pacotes de soldagem, compatibilidade ou recomendaÃ§Ãµes...",
                system_health: "SaÃºde do Sistema",
                backend_api: "API Backend",
                database: "Banco de Dados",
                ai_models: "Modelos IA",
                online: "Online",
                offline: "Offline",
                langsmith_observability: "Observabilidade LangSmith",
                trace_id: "ID do Rastreamento",
                language: "Idioma",
                mode: "Modo",
                confidence: "ConfianÃ§a",
                trinity_package: "Pacote Trinity",
                total_price: "PreÃ§o Total",
                package_contents: "ConteÃºdo do Pacote",
                compatibility_confidence: "ConfianÃ§a de Compatibilidade",
                each: "Cada",
                ready_to_ship: "Pronto para enviar",
                package_includes: "Pacote inclui guia de instalaÃ§Ã£o e garantia",
                recommended_package: "Pacote Recomendado",
                no_package_selected: "Pergunte ao Sparky por uma recomendaÃ§Ã£o para ver detalhes de preÃ§os",
                show_demo_package: "Mostrar Pacote Demo",
                pricing_details: "Detalhes de PreÃ§os"
            },
            it: {
                welcome: "Benvenuto",
                welding_expert: "Esperto di Saldatura",
                health_check: "Controllo Salute",
                ask_sparky: "Chiedi a Sparky",
                sparky_description: "Raccomandazioni per attrezzature di saldatura alimentate da IA",
                sparky_welcome: "Ciao! Sono Sparky, il tuo assistente di saldatura IA. Posso aiutarti con:<br>â€¢ Trovare l'attrezzatura di saldatura perfetta<br>â€¢ Costruire pacchetti Trinity (Fonte di Alimentazione + Alimentatore + Refrigeratore)<br>â€¢ Validazione compatibilitÃ  prodotti<br>â€¢ Raccomandazioni esperte e guidate<br><br>Quale sfida di saldatura posso aiutarti a risolvere oggi?",
                input_placeholder: "Chiedi sui pacchetti di saldatura, compatibilitÃ  o raccomandazioni...",
                system_health: "Salute del Sistema",
                backend_api: "API Backend",
                database: "Database",
                ai_models: "Modelli IA",
                online: "Online",
                offline: "Offline",
                langsmith_observability: "OsservabilitÃ  LangSmith",
                trace_id: "ID Traccia",
                language: "Lingua",
                mode: "ModalitÃ ",
                confidence: "Fiducia",
                trinity_package: "Pacchetto Trinity",
                total_price: "Prezzo Totale",
                package_contents: "Contenuto del Pacchetto",
                compatibility_confidence: "Fiducia CompatibilitÃ ",
                each: "Ciascuno",
                ready_to_ship: "Pronto per la spedizione",
                package_includes: "Il pacchetto include guida all'installazione e garanzia",
                recommended_package: "Pacchetto Raccomandato",
                no_package_selected: "Chiedi a Sparky una raccomandazione per vedere i dettagli sui prezzi",
                show_demo_package: "Mostra Pacchetto Demo",
                pricing_details: "Dettagli Prezzi"
            },
            zh: {
                welcome: "æ¬¢è¿",
                welding_expert: "ç„Šæ¥ä¸“å®¶",
                health_check: "å¥åº·æ£€æŸ¥",
                ask_sparky: "è¯¢é—®Sparky",
                sparky_description: "AIé©±åŠ¨çš„ç„Šæ¥è®¾å¤‡æ¨è",
                sparky_welcome: "æ‚¨å¥½ï¼æˆ‘æ˜¯Sparkyï¼Œæ‚¨çš„AIç„Šæ¥åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š<br>â€¢ æ‰¾åˆ°å®Œç¾çš„ç„Šæ¥è®¾å¤‡<br>â€¢ æ„å»ºä¸‰ä½ä¸€ä½“å¥—è£…ï¼ˆç”µæº+é€ä¸æœº+å†·å´å™¨ï¼‰<br>â€¢ äº§å“å…¼å®¹æ€§éªŒè¯<br>â€¢ ä¸“å®¶å’Œå¼•å¯¼å¼æ¨è<br><br>ä»Šå¤©æˆ‘å¯ä»¥å¸®æ‚¨è§£å†³ä»€ä¹ˆç„Šæ¥æŒ‘æˆ˜ï¼Ÿ",
                input_placeholder: "è¯¢é—®ç„Šæ¥å¥—è£…ã€å…¼å®¹æ€§æˆ–æ¨è...",
                system_health: "ç³»ç»Ÿå¥åº·",
                backend_api: "åç«¯API",
                database: "æ•°æ®åº“",
                ai_models: "AIæ¨¡å‹",
                online: "åœ¨çº¿",
                offline: "ç¦»çº¿",
                langsmith_observability: "LangSmithå¯è§‚æµ‹æ€§",
                trace_id: "è¿½è¸ªID",
                language: "è¯­è¨€",
                mode: "æ¨¡å¼",
                confidence: "ç½®ä¿¡åº¦",
                trinity_package: "ä¸‰ä½ä¸€ä½“å¥—è£…",
                total_price: "æ€»ä»·",
                package_contents: "å¥—è£…å†…å®¹",
                compatibility_confidence: "å…¼å®¹æ€§ç½®ä¿¡åº¦",
                each: "æ¯ä¸ª",
                ready_to_ship: "å‡†å¤‡å‘è´§",
                package_includes: "å¥—è£…åŒ…å«å®‰è£…æŒ‡å—å’Œä¿ä¿®",
                recommended_package: "æ¨èå¥—è£…",
                no_package_selected: "è¯¢é—®Sparkyè·å–æ¨èä»¥æŸ¥çœ‹ä»·æ ¼è¯¦æƒ…",
                show_demo_package: "æ˜¾ç¤ºæ¼”ç¤ºå¥—è£…",
                pricing_details: "ä»·æ ¼è¯¦æƒ…"
            },
            ja: {
                welcome: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›",
                welding_expert: "æº¶æ¥ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ",
                health_check: "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯",
                ask_sparky: "Sparkyã«èã",
                sparky_description: "AIé§†å‹•ã®æº¶æ¥æ©Ÿå™¨æ¨å¥¨",
                sparky_welcome: "ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯Sparkyã€ã‚ãªãŸã®AIæº¶æ¥ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã§ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š<br>â€¢ å®Œç’§ãªæº¶æ¥æ©Ÿå™¨ã®ç™ºè¦‹<br>â€¢ Trinityãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ§‹ç¯‰ï¼ˆé›»æº+ãƒ•ã‚£ãƒ¼ãƒ€ãƒ¼+ã‚¯ãƒ¼ãƒ©ãƒ¼ï¼‰<br>â€¢ è£½å“äº’æ›æ€§ã®æ¤œè¨¼<br>â€¢ ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã¨ã‚¬ã‚¤ãƒ‰ä»˜ãæ¨å¥¨<br><br>ä»Šæ—¥ã¯ã©ã®ã‚ˆã†ãªæº¶æ¥ã®èª²é¡Œã‚’è§£æ±ºã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
                input_placeholder: "æº¶æ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€äº’æ›æ€§ã€æ¨å¥¨ã«ã¤ã„ã¦è³ªå•...",
                system_health: "ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹",
                backend_api: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API",
                database: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",
                ai_models: "AIãƒ¢ãƒ‡ãƒ«",
                online: "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³",
                offline: "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³",
                langsmith_observability: "LangSmithè¦³æ¸¬å¯èƒ½æ€§",
                trace_id: "ãƒˆãƒ¬ãƒ¼ã‚¹ID",
                language: "è¨€èª",
                mode: "ãƒ¢ãƒ¼ãƒ‰",
                confidence: "ä¿¡é ¼åº¦",
                trinity_package: "Trinityãƒ‘ãƒƒã‚±ãƒ¼ã‚¸",
                total_price: "åˆè¨ˆä¾¡æ ¼",
                package_contents: "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…å®¹",
                compatibility_confidence: "äº’æ›æ€§ä¿¡é ¼åº¦",
                each: "å„",
                ready_to_ship: "å‡ºè·æº–å‚™å®Œäº†",
                package_includes: "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¯è¨­ç½®ã‚¬ã‚¤ãƒ‰ã¨ä¿è¨¼ãŒå«ã¾ã‚Œã¾ã™",
                recommended_package: "æ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸",
                no_package_selected: "ä¾¡æ ¼è©³ç´°ã‚’è¦‹ã‚‹ãŸã‚ã«Sparkyã«æ¨å¥¨ã‚’æ±‚ã‚ã¦ãã ã•ã„",
                show_demo_package: "ãƒ‡ãƒ¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¡¨ç¤º",
                pricing_details: "ä¾¡æ ¼è©³ç´°"
            },
            ko: {
                welcome: "í™˜ì˜í•©ë‹ˆë‹¤",
                welding_expert: "ìš©ì ‘ ì „ë¬¸ê°€",
                health_check: "ìƒíƒœ í™•ì¸",
                ask_sparky: "Sparkyì—ê²Œ ë¬¸ì˜",
                sparky_description: "AI ê¸°ë°˜ ìš©ì ‘ ì¥ë¹„ ì¶”ì²œ",
                sparky_welcome: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë‹¹ì‹ ì˜ AI ìš©ì ‘ ë„ìš°ë¯¸ Sparkyì…ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:<br>â€¢ ì™„ë²½í•œ ìš©ì ‘ ì¥ë¹„ ì°¾ê¸°<br>â€¢ Trinity íŒ¨í‚¤ì§€ êµ¬ì„± (ì „ì› + í”¼ë” + ì¿¨ëŸ¬)<br>â€¢ ì œí’ˆ í˜¸í™˜ì„± ê²€ì¦<br>â€¢ ì „ë¬¸ê°€ ë° ê°€ì´ë“œ ì¶”ì²œ<br><br>ì˜¤ëŠ˜ ì–´ë–¤ ìš©ì ‘ ê³¼ì œë¥¼ í•´ê²°í•´ ë“œë¦´ê¹Œìš”?",
                input_placeholder: "ìš©ì ‘ íŒ¨í‚¤ì§€, í˜¸í™˜ì„± ë˜ëŠ” ì¶”ì²œì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”...",
                system_health: "ì‹œìŠ¤í…œ ìƒíƒœ",
                backend_api: "ë°±ì—”ë“œ API",
                database: "ë°ì´í„°ë² ì´ìŠ¤",
                ai_models: "AI ëª¨ë¸",
                online: "ì˜¨ë¼ì¸",
                offline: "ì˜¤í”„ë¼ì¸",
                langsmith_observability: "LangSmith ê´€ì°°ê°€ëŠ¥ì„±",
                trace_id: "ì¶”ì  ID",
                language: "ì–¸ì–´",
                mode: "ëª¨ë“œ",
                confidence: "ì‹ ë¢°ë„",
                trinity_package: "Trinity íŒ¨í‚¤ì§€",
                total_price: "ì´ ê°€ê²©",
                package_contents: "íŒ¨í‚¤ì§€ ë‚´ìš©",
                compatibility_confidence: "í˜¸í™˜ì„± ì‹ ë¢°ë„",
                each: "ê°ê°",
                ready_to_ship: "ë°°ì†¡ ì¤€ë¹„ ì™„ë£Œ",
                package_includes: "íŒ¨í‚¤ì§€ì—ëŠ” ì„¤ì¹˜ ê°€ì´ë“œì™€ ë³´ì¦ì„œê°€ í¬í•¨ë©ë‹ˆë‹¤",
                recommended_package: "ì¶”ì²œ íŒ¨í‚¤ì§€",
                no_package_selected: "ê°€ê²© ì„¸ë¶€ì‚¬í•­ì„ ë³´ë ¤ë©´ Sparkyì—ê²Œ ì¶”ì²œì„ ìš”ì²­í•˜ì„¸ìš”",
                show_demo_package: "ë°ëª¨ íŒ¨í‚¤ì§€ í‘œì‹œ",
                pricing_details: "ê°€ê²© ì„¸ë¶€ì‚¬í•­"
            }
        };

        // Internationalization System
        class I18nManager {
            constructor() {
                this.currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
                this.init();
            }

            init() {
                this.updateLanguageSelector();
                this.translatePage();
            }

            updateLanguageSelector() {
                const selector = document.getElementById('languageSelector');
                if (selector) {
                    selector.value = this.currentLanguage;
                    selector.addEventListener('change', (e) => {
                        this.setLanguage(e.target.value);
                    });
                }
            }

            setLanguage(lang) {
                this.currentLanguage = lang;
                localStorage.setItem('selectedLanguage', lang);
                document.documentElement.lang = lang;
                this.translatePage();
            }

            translatePage() {
                const elements = document.querySelectorAll('[data-i18n]');
                elements.forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const translation = this.getTranslation(key);
                    if (translation) {
                        element.innerHTML = translation;
                    }
                });

                // Handle placeholder translations
                const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
                placeholderElements.forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    const translation = this.getTranslation(key);
                    if (translation) {
                        element.placeholder = translation;
                    }
                });
            }

            getTranslation(key) {
                return translations[this.currentLanguage]?.[key] || translations.en[key] || key;
            }

            getCurrentLanguage() {
                return this.currentLanguage;
            }
        }

        class ESABAgenctAIApp {
            constructor() {
                this.baseURL = 'http://localhost:8000';
                this.sessionId = `frontend_${Date.now()}`;
                this.startTime = Date.now();
                this.i18n = new I18nManager();
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.checkSystemHealth();
                this.initializeLucide();
                this.checkForGuidedFlowPackage();
                
                // Auto-check health every 30 seconds
                setInterval(() => this.checkSystemHealth(), 30000);
            }
            
            setupEventListeners() {
                // Chat functionality
                document.getElementById('sendMessage').addEventListener('click', () => this.sendMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                // Suggestion buttons
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.getElementById('chatInput').value = e.target.textContent;
                        this.sendMessage();
                    });
                });
                
                
                // Demo package button
                document.getElementById('demoPackageBtn').addEventListener('click', () => this.showDemoPackage());
                
                // Chat tab (health is now a link)
                const chatTab = document.getElementById('chatTab');
                if (chatTab) chatTab.addEventListener('click', () => this.showPage('chat'));
                
            }
            
            initializeLucide() {
                lucide.createIcons();
            }
            
            checkForGuidedFlowPackage() {
                // Check if there's a completed package from guided flow
                const packageDataStr = sessionStorage.getItem('guidedFlowCompletedPackage');
                console.log('âœ… Checking for guided flow package...', packageDataStr ? 'Found data' : 'No data');
                
                if (packageDataStr) {
                    try {
                        const packageData = JSON.parse(packageDataStr);
                        console.log('âœ… Found guided flow completed package');
                        
                        // Clear the stored data so it doesn't auto-load again
                        sessionStorage.removeItem('guidedFlowCompletedPackage');
                        
                        // Display the package in the results area
                        this.displayGuidedFlowPackage(packageData);
                        
                    } catch (error) {
                        console.error('âŒ Error parsing guided flow package data:', error);
                        sessionStorage.removeItem('guidedFlowCompletedPackage');
                    }
                }
            }
            
            displayGuidedFlowPackage(packageData) {
                console.log('ğŸ¯ Displaying guided flow package...');
                console.log('ğŸ“‹ Selected accessories from guided flow:', packageData.selections.accessories);
                
                // Filter the package data to include only the accessories selected during guided flow
                const filteredPackageData = { ...packageData.packageData };
                
                // Replace the accessories array with only the selected ones
                if (packageData.selections.accessories && packageData.selections.accessories.length > 0) {
                    filteredPackageData.accessories = packageData.selections.accessories;
                    console.log('âœ… Filtered accessories to show only selected:', filteredPackageData.accessories);
                } else {
                    // If no accessories were selected, show empty array
                    filteredPackageData.accessories = [];
                    console.log('ğŸ“ No accessories were selected in guided flow');
                }
                
                // Simulate a query result to display the package
                const simulatedResponse = {
                    query: `Guided Flow Package: ${packageData.selections.powersource?.product_name || 'Custom Package'}`,
                    packages: [filteredPackageData],
                    explanations: packageData.fullResponse.explanations || {},
                    success: true,
                    total_found: 1
                };
                
                // Show the chat page and display results
                this.showPage('chat');
                
                // Add a message indicating this came from guided flow
                const messageId = this.addMessage('assistant', 
                    `âœ… **Package completed via Guided Flow**\n\nHere's your custom Trinity package built step-by-step:`, 
                    'success');
                
                // Display the package results
                console.log('ğŸ“¦ Displaying package in right panel...');
                this.displayPackage(simulatedResponse.packages[0], simulatedResponse.explanations);
                
                // Scroll to the results
                setTimeout(() => {
                    const resultsSection = document.querySelector('#chatMessages .message:last-child');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
            }
            
            showPage(page) {
                console.log('showPage called with:', page);
                
                // For chat page, just ensure it's active (health is now a separate page)
                if (page === 'chat') {
                    const chatPage = document.getElementById('chatPage');
                    const chatTab = document.getElementById('chatTab');
                    
                    // Hide all pages
                    document.querySelectorAll('.page-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Show chat page
                    if (chatPage) chatPage.classList.add('active');
                    if (chatTab) chatTab.classList.add('active');
                }
            }
            
            
            async checkSystemHealth() {
                try {
                    const healthResponse = await fetch(`${this.baseURL}/api/v1/health/`);
                    
                    if (healthResponse.ok) {
                        this.updateSystemStatus('online', 'All systems operational');
                    } else {
                        this.updateSystemStatus('warning', 'Partial system issues');
                    }
                } catch (error) {
                    console.error('Health check failed:', error);
                    this.updateSystemStatus('offline', 'System offline');
                }
            }
            
            updateSystemStatus(status, message) {
                const indicator = document.getElementById('systemStatus').querySelector('.status-indicator');
                const text = document.getElementById('statusText');
                
                if (indicator) indicator.className = `status-indicator status-${status}`;
                if (text) text.textContent = message;
            }
            
            
            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                // Add user message to chat
                this.addMessage(message, 'user');
                input.value = '';
                
                // Show loading message
                const loadingId = this.addMessage('Thinking<span class="loading-dots"></span>', 'sparky', true);
                
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/enterprise/recommendations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: message,
                            user_context: {
                                user_id: "frontend_user",
                                experience_level: "expert",
                                preferences: {
                                    budget_range: "premium",
                                    preferred_brands: ["ESAB"],
                                    applications: ["industrial"]
                                }
                            },
                            session_id: this.sessionId,
                            language: this.i18n.getCurrentLanguage()
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Remove loading message
                    this.removeMessage(loadingId);
                    
                    if (response.ok) {
                        this.handleSuccessfulResponse(data);
                    } else {
                        this.addMessage(`Sorry, I encountered an error: ${data.detail || 'Unknown error'}`, 'sparky');
                    }
                    
                } catch (error) {
                    console.error('Chat request failed:', error);
                    this.removeMessage(loadingId);
                    this.addMessage('Sorry, I\'m having trouble connecting to the backend. Please check the system status.', 'sparky');
                    // Health check error
                }
            }
            
            handleSuccessfulResponse(data) {
                console.log('ğŸš€ DEBUG: Full API response:', data);
                console.log('ğŸš€ DEBUG: Packages received:', data.packages);
                console.log('ğŸš€ DEBUG: Number of packages:', data.packages?.length);
                if (data.packages && data.packages.length > 0) {
                    console.log('ğŸš€ DEBUG: First package structure:', data.packages[0]);
                    console.log('ğŸš€ DEBUG: First package keys:', Object.keys(data.packages[0]));
                }
                
                // Use the formatted response from the API
                const formattedResponse = data.formatted_response || {};
                const packages = data.packages || [];
                
                // Use the summary from the formatted response
                let responseText = formattedResponse.summary || `I found ${packages.length} recommendation${packages.length !== 1 ? 's' : ''} for you!`;
                
                // Add detailed explanation if available
                if (formattedResponse.detailed_explanation) {
                    responseText += `\\n\\n${formattedResponse.detailed_explanation}`;
                }
                
                // Display the first package in the pricing panel
                if (packages.length > 0) {
                    this.displayPackage(packages[0], data.generation_explanation);
                }
                
                this.addMessage(responseText, 'sparky');
            }
            
            showDemoPackage() {
                // Demo package data to show the pricing layout
                const demoPackage = {
                    total_price: 15750,
                    compatibility_confidence: 0.95,
                    components: {
                        power_source: {
                            name: "Aristo 500ix MIG/Stick Package",
                            model: "A32",
                            price: 8950,
                            specifications: "500A, Multi-process, Advanced pulse"
                        },
                        wire_feeder: {
                            name: "Warrior 500X Wire Feeder", 
                            model: "W500X",
                            price: 4200,
                            specifications: "500A, 4-roll drive, Digital display"
                        },
                        cooler: {
                            name: "Cool Arc 35 Water Cooler",
                            model: "CA35",
                            price: 2600,
                            specifications: "35L capacity, Auto-flow control"
                        }
                    }
                };
                
                this.displayPackage(demoPackage);
            }

            displayPackage(packageData, generationExplanation = null) {
                console.log('ğŸ” DEBUG: Full package data structure:', packageData);
                console.log('ğŸ” DEBUG: Package data keys:', Object.keys(packageData));
                console.log('ğŸ” DEBUG: Package data types:', Object.keys(packageData).map(k => `${k}: ${typeof packageData[k]}`));
                
                const packageDisplay = document.getElementById('packageDisplay');
                const packageContent = document.getElementById('packageContent');
                
                // Use the actual API response structure
                const totalPrice = packageData.total_price || 0;
                const compatibilityScore = packageData.compatibility_score || 0;
                const powerSource = packageData.power_source;
                const feeder = packageData.feeder;
                const cooler = packageData.cooler;
                
                // Generate package title from power source
                const packageTitle = powerSource ? `${powerSource.product_name} Package` : 'Trinity Package';
                
                let html = `
                    <div class="border-b border-gray-200 pb-4 mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xl font-bold text-esab-dark">${packageTitle}</h4>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-esab-gold">$${totalPrice.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">Total Price</div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Compatibility Confidence: ${(compatibilityScore * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h5 class="font-semibold text-gray-800 mb-3">Package Contents:</h5>
                `;
                
                // Dynamically display all components from the API response
                // Define category display mapping for better UX
                const categoryDisplayNames = {
                    'power_source': 'Power Source',
                    'feeder': 'Wire Feeder', 
                    'cooler': 'Cooling Unit',
                    'torch': 'Welding Torch',
                    'interconnector': 'Interconnection Cables',
                    'consumables': 'Consumables',
                    'accessories': 'Accessories'
                };
                
                // Get all main component fields (not arrays)
                const mainComponents = {};
                Object.keys(packageData).forEach(key => {
                    console.log(`ğŸ” DEBUG: Checking key "${key}":`, packageData[key]);
                    console.log(`ğŸ” DEBUG: Key "${key}" type:`, typeof packageData[key]);
                    console.log(`ğŸ” DEBUG: Key "${key}" is array:`, Array.isArray(packageData[key]));
                    console.log(`ğŸ” DEBUG: Key "${key}" has product_name:`, packageData[key]?.product_name);
                    
                    // Skip non-component fields and arrays
                    if (!['total_price', 'compatibility_score', 'package_score', 'trinity_compliance', 
                          'business_rule_compliance', 'currency', 'compatibility_verified', 
                          'formation_path', 'relationship_strength', 'consumables', 'accessories'].includes(key) &&
                        packageData[key] && 
                        typeof packageData[key] === 'object' && 
                        !Array.isArray(packageData[key]) &&
                        packageData[key].product_name) {
                        console.log(`âœ… DEBUG: Including component "${key}":`, packageData[key]);
                        mainComponents[key] = packageData[key];
                    } else {
                        console.log(`âŒ DEBUG: Excluding key "${key}"`);
                    }
                });
                
                console.log('ğŸ” DEBUG: Final mainComponents:', mainComponents);
                console.log('ğŸ” DEBUG: Number of main components found:', Object.keys(mainComponents).length);
                
                // Display all main components dynamically
                Object.entries(mainComponents).forEach(([category, component]) => {
                    const displayName = categoryDisplayNames[category] || category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const bgColor = category === 'power_source' ? 'from-yellow-50 to-yellow-100' : 
                                   category === 'feeder' ? 'from-blue-50 to-blue-100' :
                                   category === 'cooler' ? 'from-green-50 to-green-100' :
                                   'from-gray-50 to-gray-100';
                    
                    // Sales frequency display with visual indicator
                    const salesFreq = component.sales_frequency || 0;
                    const popularityLevel = salesFreq > 100 ? 'High' : salesFreq > 50 ? 'Medium' : salesFreq > 0 ? 'Low' : 'New';
                    const popularityColor = salesFreq > 100 ? 'text-green-600' : salesFreq > 50 ? 'text-yellow-600' : salesFreq > 0 ? 'text-orange-600' : 'text-gray-500';
                    const popularityIcon = salesFreq > 100 ? 'ğŸ”¥' : salesFreq > 50 ? 'â­' : salesFreq > 0 ? 'ğŸ“ˆ' : 'âœ¨';
                    
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r ${bgColor} rounded-lg border">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-semibold text-sm text-esab-dark">${displayName}</div>
                                    <div class="flex items-center text-xs ${popularityColor}">
                                        <span class="mr-1">${popularityIcon}</span>
                                        <span>${popularityLevel}</span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-700 mt-1">${component.product_name}</div>
                                ${component.product_id ? `<div class="text-xs text-gray-500 mt-1">ID: ${component.product_id}</div>` : ''}
                                ${salesFreq > 0 ? `<div class="text-xs text-blue-600 mt-1">Sales: ${salesFreq} units</div>` : ''}
                                ${component.description ? `<div class="text-xs text-gray-600 mt-1 line-clamp-2">${component.description.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>` : ''}
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-lg font-bold text-esab-copper">$${(component.price || 0).toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Each</div>
                            </div>
                        </div>
                    `;
                });
                
                // Display array-based components (consumables, accessories)
                ['consumables', 'accessories'].forEach(arrayCategory => {
                    const items = packageData[arrayCategory] || [];
                    if (items.length > 0) {
                        const displayName = categoryDisplayNames[arrayCategory] || arrayCategory.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        items.forEach(item => {
                            // Sales frequency display with visual indicator
                            const salesFreq = item.sales_frequency || 0;
                            const popularityLevel = salesFreq > 100 ? 'High' : salesFreq > 50 ? 'Medium' : salesFreq > 0 ? 'Low' : 'New';
                            const popularityColor = salesFreq > 100 ? 'text-green-600' : salesFreq > 50 ? 'text-yellow-600' : salesFreq > 0 ? 'text-orange-600' : 'text-gray-500';
                            const popularityIcon = salesFreq > 100 ? 'ğŸ”¥' : salesFreq > 50 ? 'â­' : salesFreq > 0 ? 'ğŸ“ˆ' : 'âœ¨';
                            
                            html += `
                                <div class="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg border">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="font-semibold text-sm text-esab-dark">${displayName}</div>
                                            <div class="flex items-center text-xs ${popularityColor}">
                                                <span class="mr-1">${popularityIcon}</span>
                                                <span>${popularityLevel}</span>
                                            </div>
                                        </div>
                                        <div class="text-sm text-gray-700 mt-1">${item.product_name}</div>
                                        ${item.product_id ? `<div class="text-xs text-gray-500 mt-1">ID: ${item.product_id}</div>` : ''}
                                        ${salesFreq > 0 ? `<div class="text-xs text-blue-600 mt-1">Sales: ${salesFreq} units</div>` : ''}
                                        ${item.description ? `<div class="text-xs text-gray-600 mt-1 line-clamp-2">${item.description.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>` : ''}
                                    </div>
                                    <div class="text-right ml-4">
                                        <div class="text-lg font-bold text-esab-copper">$${(item.price || 0).toLocaleString()}</div>
                                        <div class="text-xs text-gray-500">Each</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                
                // Add generation explanation if available
                if (generationExplanation) {
                    html += `
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="mb-4">
                                <button id="toggleExplanation" class="flex items-center justify-between w-full text-left p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
                                        <span class="font-semibold text-blue-800">How was this package generated?</span>
                                    </div>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-blue-600 transform transition-transform" id="explanationChevron"></i>
                                </button>
                                <div id="explanationContent" class="hidden mt-3 p-4 bg-gray-50 rounded-lg border">
                                    <div class="space-y-4">
                                        
                                        <!-- Query Understanding -->
                                        <div class="border-b border-gray-200 pb-3">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                <i data-lucide="search" class="w-4 h-4 text-green-600"></i>
                                                Query Understanding
                                            </h4>
                                            <p class="text-sm text-gray-700">${generationExplanation.user_query_analysis}</p>
                                            ${Object.keys(generationExplanation.detected_requirements || {}).length > 0 ? `
                                                <div class="mt-2">
                                                    <span class="text-xs font-medium text-gray-600">Detected Requirements:</span>
                                                    <ul class="text-xs text-gray-600 mt-1 ml-4">
                                                        ${generationExplanation.detected_requirements.welding_processes?.length > 0 ? `<li>â€¢ Processes: ${generationExplanation.detected_requirements.welding_processes.join(', ')}</li>` : ''}
                                                        ${generationExplanation.detected_requirements.materials?.length > 0 ? `<li>â€¢ Materials: ${generationExplanation.detected_requirements.materials.join(', ')}</li>` : ''}
                                                        ${generationExplanation.detected_requirements.expertise_level ? `<li>â€¢ Expertise: ${generationExplanation.detected_requirements.expertise_level}</li>` : ''}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <!-- Search Strategy -->
                                        <div class="border-b border-gray-200 pb-3">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                <i data-lucide="target" class="w-4 h-4 text-blue-600"></i>
                                                Search Strategy
                                            </h4>
                                            <p class="text-sm text-gray-700">${generationExplanation.search_strategy_reasoning}</p>
                                            ${generationExplanation.trinity_formation_process ? `<p class="text-sm text-gray-700 mt-1">${generationExplanation.trinity_formation_process}</p>` : ''}
                                        </div>
                                        
                                        <!-- Component Selection -->
                                        <div class="border-b border-gray-200 pb-3">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                <i data-lucide="settings" class="w-4 h-4 text-purple-600"></i>
                                                Component Selection
                                            </h4>
                                            ${generationExplanation.power_source_selection_reason ? `<p class="text-sm text-gray-700 mb-1"><strong>Power Source:</strong> ${generationExplanation.power_source_selection_reason}</p>` : ''}
                                            ${generationExplanation.feeder_selection_reason ? `<p class="text-sm text-gray-700 mb-1"><strong>Feeder:</strong> ${generationExplanation.feeder_selection_reason}</p>` : ''}
                                            ${generationExplanation.cooler_selection_reason ? `<p class="text-sm text-gray-700 mb-1"><strong>Cooler:</strong> ${generationExplanation.cooler_selection_reason}</p>` : ''}
                                            ${generationExplanation.accessories_selection_criteria ? `<p class="text-sm text-gray-700"><strong>Accessories:</strong> ${generationExplanation.accessories_selection_criteria}</p>` : ''}
                                        </div>
                                        
                                        <!-- Business Rules -->
                                        <div>
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                <i data-lucide="shield-check" class="w-4 h-4 text-orange-600"></i>
                                                Business Rules Applied
                                            </h4>
                                            ${generationExplanation.business_rules_applied?.length > 0 ? `
                                                <ul class="text-sm text-gray-700 space-y-1">
                                                    ${generationExplanation.business_rules_applied.map(rule => `<li class="flex items-start gap-2"><i data-lucide="check" class="w-3 h-3 text-green-600 mt-0.5 flex-shrink-0"></i><span>${rule}</span></li>`).join('')}
                                                </ul>
                                            ` : '<p class="text-sm text-gray-500">No specific business rules applied</p>'}
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <span>Package includes installation guide and warranty</span>
                                <span class="font-medium">Ready to ship</span>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <span>Package includes installation guide and warranty</span>
                                <span class="font-medium">Ready to ship</span>
                            </div>
                        </div>
                    `;
                }
                
                packageContent.innerHTML = html;
                packageDisplay.style.display = 'block';
                
                // Add event listener for the explanation toggle button
                if (generationExplanation) {
                    setTimeout(() => {
                        const toggleBtn = document.getElementById('toggleExplanation');
                        const explanationContent = document.getElementById('explanationContent');
                        const chevron = document.getElementById('explanationChevron');
                        
                        if (toggleBtn && explanationContent && chevron) {
                            toggleBtn.addEventListener('click', () => {
                                if (explanationContent.classList.contains('hidden')) {
                                    explanationContent.classList.remove('hidden');
                                    chevron.style.transform = 'rotate(180deg)';
                                } else {
                                    explanationContent.classList.add('hidden');
                                    chevron.style.transform = 'rotate(0deg)';
                                }
                            });
                        }
                    }, 100); // Small delay to ensure DOM is updated
                }
            }
            
            
            addMessage(content, sender, isLoading = false) {
                const messagesDiv = document.getElementById('chatMessages');
                const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = `message-${sender} p-4 rounded-lg fade-in`;
                
                const icon = sender === 'sparky' ? 'zap' : 'user';
                const senderName = sender === 'sparky' ? 'Sparky' : 'You';
                
                messageDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="${icon}" class="w-4 h-4 ${sender === 'sparky' ? 'text-yellow-600' : 'text-gray-700'}"></i>
                        <span class="font-medium">${senderName}</span>
                    </div>
                    <div class="text-gray-800">${content}</div>
                `;
                
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                this.initializeLucide();
                
                return messageId;
            }
            
            removeMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ESABAgenctAIApp();
        });
    </script>
</body>
</html>